# План доработки Desktop приложения vCAD

Этот план является основой для последующего переноса в Web.

---

## Текущий статус

| Категория | Готово | Частично | Не реализовано |
|-----------|--------|----------|----------------|
| Примитивы | 4/4 | - | - |
| Sketch элементы | 7/7 | - | - |
| Sketch операции | 3/4 | 1/4 | - |
| 3D операции | 4/5 | 1/5 | - |
| Constraints | 10/10 | - | - |
| Параметризация | 3/3 | - | - |
| UI | 95% | 5% | - |
| Экспорт | 1/4 | - | 3/4 |

---

## Приоритет 1: Критические доработки

### 1.1 Завершить BooleanModify между телами
**Статус:** ✅ Реализовано
**Файл:** `crates/gui/src/build/body_builder.rs:157`

**Задачи:**
- [x] Реализовать поиск tool_body по ID
- [x] Применить CSG операцию (union/difference/intersection)
- [x] Обновить mesh результата
- [ ] Тесты для всех трёх операций

---

### 1.2 Интеграция AI чата
**Статус:** Заглушка
**Файл:** `crates/gui/src/state/chat.rs`

**Текущее состояние:**
- UI чата есть
- Отправка сообщений работает
- Ответы возвращают заглушку

**Задачи:**
- [ ] Подключить API (локальный LLM или облачный)
- [ ] Парсинг команд из ответа AI
- [ ] Выполнение команд (создание тел, эскизов)
- [ ] Показ результата в чате

---

### 1.3 Дополнительные ограничения (Constraints)
**Статус:** ✅ 10 из 10 реализовано

**Реализовано:**
- [x] Horizontal
- [x] Vertical
- [x] Parallel
- [x] Perpendicular
- [x] Coincident
- [x] Fixed
- [x] **Equal** — равные длины/радиусы
- [x] **Tangent** — касательная (линия к окружности)
- [x] **Concentric** — концентрические окружности
- [x] **Symmetric** — симметрия относительно линии

**Файлы:**
- `crates/shared/src/lib.rs` — типы добавлены
- `crates/gui/src/sketch/constraints.rs` — solver реализован
- `crates/gui/src/ui/properties.rs` — отображение в UI
- `crates/gui/src/i18n.rs` — переводы

---

## Приоритет 2: Параметризация (основа для SaaS)

### 2.1 Переменные и параметры
**Статус:** ✅ Реализовано

**Структура данных:**
```rust
// crates/shared/src/lib.rs
pub struct Parameter {
    pub name: String,
    pub value: ParameterValue,
    pub unit: Option<String>,
    pub description: Option<String>,
}

pub enum ParameterValue {
    Number { value: f64 },
    Formula { expression: String },
    Reference { reference: ParameterRef },
}
```

**Выполнено:**
- [x] Добавить `parameters: HashMap<String, Parameter>` в Body
- [x] Парсер формул (evalexpr)
- [x] Граф зависимостей
- [x] Пересчёт при изменении
- [x] Обнаружение циклических зависимостей

**Файлы:**
- `crates/shared/src/lib.rs` — структуры данных
- `crates/shared/src/parameters.rs` — вычисление формул

---

### 2.2 UI панель параметров
**Статус:** ✅ Реализовано

**Функции:**
- [x] Добавление новых параметров
- [x] Редактирование имени параметра
- [x] Редактирование значения (число или формула)
- [x] Переключение между режимом числа и формулы
- [x] Удаление параметров
- [x] Единицы измерения
- [x] Отображение вычисленного значения формулы
- [x] Отображение ошибок вычисления

**Файл:** `crates/gui/src/ui/parameters.rs`

---

### 2.3 Связи между размерами
**Статус:** ✅ Реализовано

**Выполнено:**
- [x] UI для привязки размера к параметру (ComboBox в свойствах)
- [x] Автоматическое обновление размера при изменении параметра
- [x] Блокировка редактирования связанных размеров
- [x] Обнаружение циклических зависимостей

**Файлы:**
- `crates/gui/src/ui/properties.rs` — UI привязки
- `crates/shared/src/lib.rs` — поле `parameter_name` в Dimension

---

## Приоритет 3: Sketch операции

### 3.1 Offset (смещение контура)
**Статус:** ✅ Реализовано
**Файл:** `crates/gui/src/sketch/offset.rs`

**Выполнено:**
- [x] Кнопка в toolbar эскиза
- [x] Ввод величины смещения
- [x] Применение к линиям и окружностям

---

### 3.2 Trim (обрезка)
**Статус:** ✅ Реализовано
**Файл:** `crates/gui/src/sketch/geometry.rs`

**Выполнено:**
- [x] Кнопка Trim в toolbar
- [x] Клик по сегменту для обрезки
- [x] Работает с линиями, дугами, окружностями

---

### 3.3 Fillet 2D (скругление углов)
**Статус:** ✅ Реализовано

**Выполнено:**
- [x] Кнопка Fillet в toolbar
- [x] Клик на угол для скругления
- [x] Настраиваемый радиус

---

### 3.4 Dimension (размерные линии)
**Статус:** ✅ Реализовано

**Выполнено:**
- [x] Линейные размеры (линии, прямоугольники)
- [x] Радиус окружности (клик по центру)
- [x] Диаметр окружности (клик по контуру)
- [x] Редактирование размера в свойствах
- [x] Автоматическое обновление геометрии при изменении размера
- [x] Привязка к параметрам

**Файлы:**
- `crates/gui/src/state/sketch.rs` — логика создания
- `crates/gui/src/viewport/mod.rs` — обработка кликов
- `crates/gui/src/ui/properties.rs` — редактирование

---

### 3.5 Mirror (зеркальное отражение)
**Статус:** ✅ Полностью реализовано

**Выполнено:**
- [x] Симметрия через constraint
- [x] Отметка линии как оси симметрии
- [x] Mirror copy / Mirror move в контекстном меню
- [x] Отдельный инструмент Mirror в toolbar

**Использование инструмента Mirror:**
1. Выбрать элементы для отражения
2. Активировать инструмент "Зеркало"
3. Кликнуть на линию-ось симметрии

---

### 3.6 Pattern (массив)
**Статус:** ✅ Реализовано

**Типы:**
- Linear pattern (линейный массив)
- Circular pattern (круговой массив)

**Выполнено:**
- [x] UI для выбора типа паттерна
- [x] Параметры (количество, шаг/угол, направление)
- [x] Предпросмотр (ghost-элементы)
- [x] Применение к выбранным элементам
- [x] Выбор центра для кругового массива

**Файлы:**
- `crates/gui/src/sketch/pattern.rs` — логика linear_pattern, circular_pattern
- `crates/gui/src/state/sketch.rs` — PatternType, PatternParams
- `crates/gui/src/ui/sketch_toolbar.rs` — UI настроек паттерна
- `crates/gui/src/viewport/overlays.rs` — предпросмотр паттерна

---

### 3.7 Улучшение Spline
**Статус:** Базовая реализация есть

**Задачи:**
- [ ] Редактирование контрольных точек
- [ ] Касательные в точках
- [ ] Конвертация в polyline для экструзии

---

## Приоритет 4: 3D операции

### 4.1 Extrude (выдавливание)
**Статус:** ✅ Реализовано

**Выполнено:**
- [x] Высота вперёд/назад
- [x] Угол уклона (draft angle)
- [x] Предпросмотр

---

### 4.2 Revolve (вращение)
**Статус:** ✅ Реализовано

**Выполнено:**
- [x] Выбор оси вращения (construction line)
- [x] Угол вращения
- [x] Предпросмотр с ghost-профилями

---

### 4.3 Cut (вырез)
**Статус:** ✅ Реализовано

**Выполнено:**
- [x] Cut Extrude
- [x] Cut Revolve

---

### 4.4 Chamfer (фаска)
**Статус:** Не реализовано

**Задачи:**
- [ ] Выбор рёбер на 3D модели
- [ ] Параметры (размер, угол)
- [ ] CSG реализация

---

### 4.5 Fillet 3D (скругление рёбер)
**Статус:** Не реализовано (есть только 2D fillet в эскизе)

**Задачи:**
- [ ] Выбор рёбер на 3D модели
- [ ] Параметр радиуса
- [ ] CSG реализация

---

### 4.6 Shell (оболочка)
**Статус:** Не реализовано

**Задачи:**
- [ ] Выбор граней для удаления
- [ ] Параметр толщины стенки
- [ ] CSG реализация

---

### 4.7 Loft (по сечениям)
**Статус:** Не реализовано

**Задачи:**
- [ ] Выбор нескольких эскизов-сечений
- [ ] Интерполяция между сечениями
- [ ] Mesh генерация

---

### 4.8 Sweep (по траектории)
**Статус:** Не реализовано

**Задачи:**
- [ ] Выбор профиля и траектории
- [ ] Mesh генерация вдоль пути

---

## Приоритет 5: Настройки и UI

### 5.1 Настройки размерных линий
**Статус:** ✅ Реализовано

**Выполнено:**
- [x] Размер шрифта размеров
- [x] Точность отображения (знаков после запятой)
- [x] Показ/скрытие единиц измерения

**Файлы:**
- `crates/gui/src/state/settings.rs` — DimensionSettings
- `crates/gui/src/app/menus.rs` — UI настроек
- `crates/gui/src/viewport/renderer.rs` — применение настроек

---

### 5.2 Настройки отображения
**Статус:** ✅ Реализовано

**Выполнено:**
- [x] Единицы измерения (мм, см, м, дюймы)
- [x] Настройки сетки (размер, видимость, прозрачность)
- [x] Настройки осей (длина, толщина, метки)
- [x] Цвет фона и выделения
- [x] Настройки привязок (snap)
- [x] Размер шрифта интерфейса

---

### 5.3 Measurement tool (измерения)
**Статус:** Не реализовано

**Задачи:**
- [ ] Измерение расстояния между точками
- [ ] Измерение угла
- [ ] Измерение радиуса/диаметра
- [ ] Отображение результата на экране

---

### 5.4 Section view (разрез)
**Статус:** Не реализовано

**Задачи:**
- [ ] Выбор плоскости сечения
- [ ] Рендеринг разреза
- [ ] Toggle on/off

---

### 5.5 ViewCube (навигационный куб)
**Статус:** ✅ Реализовано

**Выполнено:**
- [x] 3D куб в углу viewport
- [x] Отображение граней (Front, Back, Left, Right, Top, Bottom)
- [x] Вращение куба вместе с камерой
- [x] Клик по грани переключает камеру на соответствующий вид
- [x] Поддержка стандартных видов (Isometric)

**Файлы:**
- `crates/gui/src/viewport/camera.rs` — StandardView enum, set_standard_view()
- `crates/gui/src/viewport/overlays.rs` — draw_view_cube(), hit_test_view_cube()
- `crates/gui/src/viewport/mod.rs` — view_cube_state, handle_view_cube_click()
- `crates/gui/src/i18n.rs` — переводы (view.front, view.back, etc.)

---

## Приоритет 6: Экспорт

### 6.1 GLB экспорт
**Статус:** ✅ Реализовано

---

### 6.2 STL экспорт
**Статус:** Не реализовано

**Задачи:**
- [ ] ASCII STL формат
- [ ] Binary STL формат
- [ ] UI кнопка экспорта

---

### 6.3 OBJ экспорт
**Статус:** Не реализовано

**Задачи:**
- [ ] OBJ формат с вершинами и нормалями
- [ ] MTL файл для материалов

---

### 6.4 STEP экспорт
**Статус:** Не реализовано

**Сложность:** Высокая (требует BREP представление)

**Задачи:**
- [ ] Исследовать библиотеки (opencascade-rs?)
- [ ] Конвертация mesh → BREP
- [ ] Запись STEP файла

---

### 6.5 3MF экспорт
**Статус:** Не реализовано

**Задачи:**
- [ ] XML структура 3MF
- [ ] Упаковка в ZIP
- [ ] Метаданные (цвет, материал)

---

## Приоритет 7: Производительность

### 7.1 Оптимизация CSG
**Статус:** Работает, но может быть медленно

**Задачи:**
- [ ] Кэширование промежуточных результатов
- [ ] Параллельные вычисления (rayon)
- [ ] LOD для preview

---

### 7.2 Lazy mesh generation
**Статус:** Не реализовано

**Задачи:**
- [ ] Генерация mesh только для видимых тел
- [ ] Отложенная генерация при скролле дерева

---

### 7.3 Улучшение Undo/Redo
**Статус:** Работает (100 состояний max)

**Задачи:**
- [ ] Сжатие состояний (diff вместо full copy)
- [ ] Увеличить лимит без роста памяти
- [ ] Показ списка операций для отката

---

## Приоритет 8: Качество кода

### 8.1 Тесты
**Статус:** Минимальные

**Задачи:**
- [ ] Unit тесты для sketch operations
- [ ] Unit тесты для constraint solver
- [ ] Integration тесты для build pipeline
- [ ] UI тесты (snapshot testing)

---

### 8.2 Документация
**Статус:** Частичная

**Задачи:**
- [ ] Rustdoc для публичных API
- [ ] Примеры использования
- [ ] Architecture decision records (ADR)

---

### 8.3 Error handling
**Статус:** Логирование есть, UI feedback частичный

**Задачи:**
- [ ] Показ ошибок пользователю (toast/dialog)
- [ ] Детальные сообщения об ошибках
- [ ] Recovery от ошибок (не crash)

---

## Сводка задач

| Приоритет | Категория | Задач | Статус |
|-----------|-----------|-------|--------|
| 1 | Критические | 3 | ✅ 2/3 выполнено |
| 2 | Параметризация | 3 | ✅ 3/3 выполнено |
| 3 | Sketch операции | 7 | ✅ 7/7 выполнено |
| 4 | 3D операции | 8 | ✅ 3/8 выполнено |
| 5 | Настройки и UI | 5 | ✅ 3/5 выполнено |
| 6 | Экспорт | 5 | ✅ 1/5 выполнено |
| 7 | Производительность | 3 | ⏳ 0/3 |
| 8 | Качество кода | 3 | ⏳ 0/3 |

---

## Чек-лист готовности к Web

Перед переносом в Web должно быть готово:

- [x] Параметризация (переменные, формулы, связи)
- [x] Все базовые constraints (10/10)
- [x] Размерные линии с привязкой к параметрам
- [ ] STL и OBJ экспорт
- [ ] Стабильный API без breaking changes
- [ ] Тесты покрывают критические пути
- [ ] Документация API

---

*Документ создан: 2026-02-11*
*Последнее обновление: 2026-02-12*
*Исправлен баг: выбор центра для кругового паттерна*
